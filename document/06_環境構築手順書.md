# SNCライブラリ - グラフィックデザイン：環境構築手順書（Laravel版）

作成日: 2026-02-04  
更新日: 2026-02-05（Docker構成更新）

## 1. 概要

本ドキュメントは、Laravel 10.xを使用して以下の環境でアプリケーションを構築・実行するための手順を記載しています：

- **開発/テスト環境**: Docker Compose（macOS上で実行）
- **本番環境**: Xserver レンタルサーバー

---

## 2. テスト環境（Docker）のセットアップ

### 2.1 前提条件

- macOS
- Docker Desktop for Mac がインストール済み
- Git がインストール済み（任意）

**注意**: Composerはコンテナ内にインストール済みのため、ローカルへのインストールは不要です。

### 2.2 プロジェクトのクローン

```bash
# プロジェクトディレクトリに移動
cd /Users/jun/Documents/_app

# プロジェクトをクローン（既に存在する場合はスキップ）
# git clone <repository-url> library_app_docker

# プロジェクトディレクトリに移動
cd library_app_docker
```

### 2.3 Docker環境の起動

```bash
# Docker Composeでコンテナをビルド・起動
docker-compose up -d --build

# ログを確認（初回起動時）
docker-compose logs -f app

# 起動確認
docker-compose ps
```

### 2.4 Laravelプロジェクトのセットアップ

#### 方法A: コンテナ内で新規Laravel作成（推奨）

```bash
# コンテナ内に入る
docker-compose exec app bash

# Laravelプロジェクトを作成（srcディレクトリに）
cd /var/www/html
composer create-project laravel/laravel . "10.*"

# Intervention Imageをインストール
composer require intervention/image

# APP_KEYの生成
php artisan key:generate

# .envファイルのDB設定を編集
# DB_HOST=db
# DB_DATABASE=library_db
# DB_USERNAME=library_user
# DB_PASSWORD=library_pass

# ストレージディレクトリ作成
mkdir -p storage/app/public/uploads/{original,display,thumb}
chmod -R 775 storage bootstrap/cache

# ストレージリンクの作成
php artisan storage:link

# コンテナから退出
exit
```

#### 方法B: 既存プロジェクトを配置

```bash
# 既存のLaravelプロジェクトをsrcディレクトリにコピー
cp -r /path/to/existing/laravel/* ./src/

# コンテナ内で依存関係をインストール
docker-compose exec app composer install

# .envファイルを設定
docker-compose exec app cp .env.example .env
docker-compose exec app php artisan key:generate

# 権限設定
docker-compose exec app chmod -R 775 storage bootstrap/cache
```

### 2.5 ディレクトリ構成

本プロジェクトのディレクトリ構成：

```
library_app_docker/              # プロジェクトルート
├── docker/                      # Docker設定
│   ├── php/
│   │   ├── Dockerfile          # PHP + Apache設定
│   │   └── entrypoint.sh       # 起動時スクリプト
│   └── mysql/
│       └── init/
│           └── 01_init.sql     # DB初期化スクリプト
├── src/                         # Laravelプロジェクト（ここに配置）
│   ├── app/                    # アプリケーションコード
│   │   ├── Http/
│   │   │   ├── Controllers/
│   │   │   │   ├── HomeController.php
│   │   │   │   ├── Admin/
│   │   │   │   └── Api/
│   │   │   └── Middleware/
│   │   │       └── AdminAuth.php
│   │   ├── Models/
│   │   │   ├── Genre.php
│   │   │   ├── Tag.php
│   │   │   └── Image.php
│   │   └── Services/
│   │       └── ImageProcessingService.php
│   ├── database/
│   │   ├── migrations/
│   │   └── seeders/
│   ├── resources/
│   │   ├── views/             # Bladeテンプレート
│   │   ├── css/
│   │   └── js/
│   ├── routes/
│   │   └── web.php            # ルート定義
│   ├── public/                # Webルート
│   │   └── index.php
│   ├── storage/
│   │   └── app/
│   │       └── public/
│   │           └── uploads/   # 画像保存領域
│   └── .env                   # 環境変数
├── document/                    # プロジェクトドキュメント
│   ├── 01_要件定義.md
│   ├── 02_仕様書.md
│   ├── 03_設計書.md
│   ├── 04_DB初期化.sql
│   ├── 05_デプロイ運用.md
│   └── 06_環境構築手順書.md
├── docker-compose.yml           # Docker Compose設定
├── .env.example                 # Laravel環境変数サンプル
├── .gitignore
└── README.md                    # プロジェクト説明
```

### 2.6 データベース初期化

```bash
# コンテナ内でマイグレーション実行
docker-compose exec app php artisan migrate

# または、SQLファイルを直接インポート
docker-compose exec -T db mysql -u library_user -plibrary_pass library_db < ./document/04_DB初期化.sql
```

### 2.7 動作確認

- **アプリケーション**: http://localhost:8080
- **phpMyAdmin**: http://localhost:8081
  - ユーザー名: `library_user`
  - パスワード: `library_pass`

### 2.8 環境変数の設定

Laravelの `.env` ファイルで以下の設定を確認：

```env
APP_NAME="SNC Library"
APP_ENV=local
APP_KEY=base64:XXXXXX  # php artisan key:generate で生成
APP_DEBUG=true
APP_URL=http://localhost:8080

# Database Configuration (Docker)
DB_CONNECTION=mysql
DB_HOST=db                 # docker-composeのサービス名
DB_PORT=3306
DB_DATABASE=library_db
DB_USERNAME=library_user
DB_PASSWORD=library_pass

# Session/Cache
CACHE_DRIVER=file
SESSION_DRIVER=file
SESSION_LIFETIME=120

# Admin Password (カスタム設定)
ADMIN_PASSWORD_HASH='$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi'

# Image Processing (カスタム設定)
MAX_DISPLAY_WIDTH=4096
THUMB_MAX_SIZE=512
```

### 2.9 よく使うDockerコマンド

```bash
# コンテナ起動
docker-compose up -d

# コンテナ停止
docker-compose down

# コンテナ再起動
docker-compose restart

# ログ確認
docker-compose logs -f app

# コンテナ内でコマンド実行
docker-compose exec app bash
docker-compose exec app php artisan migrate
docker-compose exec app composer install

# データベースに接続
docker-compose exec db mysql -u library_user -plibrary_pass library_db

# データベース含めて完全削除（注意）
docker-compose down -v
```

---

## 3. 本番環境（Xserver）のセットアップ

### 3.1 前提条件

- Xserver契約済み
- SSH接続可能（推奨）またはファイルマネージャー利用
- PHPバージョン: 8.1以上推奨
- MySQL 8.0以上
- Composer（ローカル環境で依存関係をインストールしてからアップロード）

### 3.2 Xserverでの事前準備

#### 3.2.1 データベースの作成

1. Xserverサーバーパネルにログイン
2. 「MySQL設定」を開く
3. 「MySQL追加」タブで新規データベースを作成
   - データベース名: `xsrv123_library`（任意）
4. 「MySQLユーザー追加」タブでユーザーを作成
5. 「アクセス権所有ユーザー」でユーザーとDBを紐付け
6. 接続情報（ホスト名、ユーザー名、パスワード）をメモ

#### 3.2.2 PHP設定の確認

1. サーバーパネルで「PHP Ver.切替」を開く
2. PHP 8.1以上を選択
3. 「php.ini設定」で以下を確認・調整：

```ini
upload_max_filesize = 100M
post_max_size = 100M
memory_limit = 256M
max_execution_time = 300
```

#### 3.2.3 ドメイン/サブドメインの設定

1. 「ドメイン設定」または「サブドメイン設定」を開く
2. 使用するドメイン/サブドメインを追加
3. 「公開フォルダ」を `library_app/public` と指定（重要）

#### 3.2.4 Basic認証の設定（推奨）

1. サーバーパネルで「アクセス制限」を開く
2. 保護するディレクトリを選択
3. ユーザー名とパスワードを設定

### 3.3 ローカルでの準備作業

#### 3.3.1 本番用の依存関係インストール

```bash
# プロジェクトルートで実行

# 本番用の依存関係のみインストール（開発用パッケージを除外）
composer install --no-dev --optimize-autoloader

# キャッシュをクリア
php artisan config:clear
php artisan route:clear
php artisan view:clear
```

#### 3.3.2 アーカイブの作成

```bash
# tar.gzで圧縮（node_modules、.gitなどを除外）
tar -czf library_app.tar.gz \
  --exclude='node_modules' \
  --exclude='.git' \
  --exclude='docker' \
  --exclude='document' \
  --exclude='storage/logs/*' \
  --exclude='storage/framework/cache/*' \
  --exclude='storage/framework/sessions/*' \
  --exclude='storage/framework/views/*' \
  --exclude='tests' \
  --exclude='.env' \
  app/ bootstrap/ config/ database/ public/ resources/ routes/ storage/ vendor/ artisan composer.json composer.lock
```

### 3.4 ファイルのアップロード

#### 3.4.1 SSH経由でのアップロード（推奨）

```bash
# SCPでアップロード
scp library_app.tar.gz xserver_user@your-server.xsrv.jp:~/

# SSH接続して解凍
ssh xserver_user@your-server.xsrv.jp
cd ~/
tar -xzf library_app.tar.gz -C library_app/
```

または rsync を使用：

```bash
# rsyncで直接アップロード
rsync -avz --exclude='node_modules' \
  --exclude='.git' \
  --exclude='docker' \
  --exclude='document' \
  --exclude='tests' \
  --exclude='.env' \
  ./ xserver_user@your-server.xsrv.jp:~/library_app/
```

#### 3.4.2 FTPクライアント経由でのアップロード

- FileZilla、Cyberduck等のFTPクライアントを使用
- 以下のディレクトリ/ファイルをアップロード：
  - `app/`
  - `bootstrap/`
  - `config/`
  - `database/`
  - `public/`
  - `resources/`
  - `routes/`
  - `storage/`（ディレクトリ構造のみ）
  - `vendor/`
  - `artisan`
  - `composer.json`
  - `composer.lock`

### 3.5 ディレクトリ配置の確認

Xserver上のディレクトリ構成：

```
~/library_app/              # Laravelプロジェクトルート
├── app/
├── bootstrap/
├── config/
├── database/
├── public/                 # Webルート（DocumentRoot）
│   ├── index.php
│   └── .htaccess
├── resources/
├── routes/
├── storage/
├── vendor/
├── .env
└── artisan
```

**重要**: ドメイン設定で「公開フォルダ」を `library_app/public` に設定してください。 \
  --exclude='public/uploads/*' \
  public/ src/ config/ scripts/ .env

# SCPでアップロード
scp library_app.tar.gz xserver_user@your-server.xsrv.jp:~/

# SSH接続して解凍
ssh xserver_user@your-server.xsrv.jp
cd ~/library_app
tar -xzf ../library_app.tar.gz
```

#### 3.3.2 FTPクライアント経由でのアップロード

### 3.6 環境変数ファイルの設定

SSH接続またはファイルマネージャーで `.env` を作成・編集：

```env
APP_NAME="SNC Library"
APP_ENV=production
APP_KEY=base64:XXXXXX  # ローカルで生成したものをコピー
APP_DEBUG=false
APP_URL=https://yourdomain.com

# Database Configuration (Xserver)
DB_CONNECTION=mysql
DB_HOST=mysql123.xserver.jp          # Xserverから提供されるホスト名
DB_PORT=3306
DB_DATABASE=xsrv123_library          # 作成したDB名
DB_USERNAME=xsrv123_user             # 作成したユーザー名
DB_PASSWORD=your_secure_password     # 設定したパスワード

# Cache & Session
CACHE_DRIVER=file
SESSION_DRIVER=file
SESSION_LIFETIME=120
QUEUE_CONNECTION=sync

# Admin Password (カスタム設定)
# 必ず変更してください！Hash::make()で生成
ADMIN_PASSWORD_HASH='$2y$10$NEW_HASH_HERE'

# Image Processing (カスタム設定)
MAX_DISPLAY_WIDTH=4096
THUMB_MAX_SIZE=512

# Logging
LOG_CHANNEL=daily
LOG_LEVEL=error
```

### 3.7 パーミッション設定

SSH接続して実行：

```bash
cd ~/library_app

# ストレージとキャッシュディレクトリの権限設定
chmod -R 775 storage bootstrap/cache

# 画像アップロード用ディレクトリ作成と権限設定
mkdir -p storage/app/public/uploads/{original,display,thumb}
chmod -R 775 storage/app/public

# .envファイルのセキュリティ
chmod 600 .env
```

### 3.8 ストレージリンクの作成

```bash
# SSH接続して実行
cd ~/library_app

# ストレージリンクを作成（publicからstorageへのシンボリックリンク）
php artisan storage:link
```

### 3.9 データベース初期化

#### 3.9.1 Laravelマイグレーション（推奨）

```bash
# SSH接続して実行
cd ~/library_app

# マイグレーション実行
php artisan migrate --force

# 初期データ投入（Seederがある場合）
php artisan db:seed --force
```

#### 3.9.2 SQLファイル直接実行

```bash
# SSH接続
ssh xserver_user@your-server.xsrv.jp

# SQLファイルをアップロード（事前に実施）
cd ~/library_app

# MySQLにインポート
mysql -h mysql123.xserver.jp \
  -u xsrv123_user \
  -p \
  xsrv123_library < database/migrations/initial_schema.sql
```

または phpMyAdmin 経由：
1. Xserverサーバーパネルから「phpMyAdmin」を開く
2. 作成したデータベースを選択
3. 「SQL」タブを開く
4. SQLファイルの内容を貼り付けて実行

### 3.10 本番環境の最適化

```bash
# SSH接続して実行
cd ~/library_app

# 設定キャッシュの生成
php artisan config:cache

# ルートキャッシュの生成
php artisan route:cache

# ビューキャッシュの生成
php artisan view:cache

# Composerオートローダーの最適化（既に実施済みの場合は不要）
composer dump-autoload --optimize --no-dev
```

### 3.11 管理者パスワードの生成

```bash
# SSH接続またはローカルで実行

# Laravelのtinkerを使用
php artisan tinker

# tinker内で実行
>>> Hash::make('your_secure_password')
=> "$2y$10$..."

# 出力されたハッシュを.envのADMIN_PASSWORD_HASHに設定
```

または、簡単なスクリプトを作成：

```bash
# SSH接続して実行
cd ~/library_app

# 一時スクリプトを作成
php -r "echo 'Hash: ' . password_hash('your_secure_password', PASSWORD_BCRYPT) . PHP_EOL;"
```

### 3.12 動作確認

1. ブラウザで `https://yourdomain.com` にアクセス
2. Basic認証（設定した場合）の確認
3. Laravelのウェルカムページまたはトップページが表示されることを確認
4. `/admin/login` にアクセスして管理画面ログインを確認
5. テスト画像のアップロード・表示を確認

### 3.13 セキュリティチェックリスト

- [ ] Basic認証が設定されている
- [ ] `.env` のパーミッションが 600 になっている
- [ ] `APP_DEBUG=false` になっている（本番環境）
- [ ] 管理者パスワードが初期値から変更されている
- [ ] HTTPSが有効になっている
- [ ] 不要なファイル（`info.php`等）が削除されている
- [ ] `storage/` と `bootstrap/cache/` のパーミッションが適切
- [ ] Laravel のキャッシュが有効化されている

---

## 4. トラブルシューティング

### 4.1 Docker環境

#### 問題: コンテナが起動しない

```bash
# ログを確認
docker-compose logs

# コンテナの状態確認
docker-compose ps

# 再ビルド
docker-compose down
docker-compose up -d --build
```

#### 問題: データベース接続エラー

- `.env` の DB_HOST が `db` になっているか確認
- コンテナ間の通信を確認: `docker-compose exec app ping db`
- マイグレーション実行: `docker-compose exec app php artisan migrate`

#### 問題: Composer依存関係のエラー

```bash
# コンテナ内で再インストール
docker-compose exec app composer install

# または Composer キャッシュをクリア
docker-compose exec app composer clear-cache
docker-compose exec app composer install
```

#### 問題: 画像アップロードができない

```bash
# パーミッション確認
docker-compose exec app ls -la /var/www/html/storage/app/public

# 権限付与
docker-compose exec app chmod -R 775 /var/www/html/storage
docker-compose exec app chown -R www-data:www-data /var/www/html/storage

# ストレージリンク再作成
docker-compose exec app php artisan storage:link
```

### 4.2 Xserver環境

#### 問題: 500 Internal Server Error

1. エラーログを確認：
   ```bash
   tail -f ~/library_app/storage/logs/laravel.log
   ```
   または Xserverのエラーログ
   
2. `.env` ファイルが存在し、`APP_KEY` が設定されているか確認
   ```bash
   php artisan key:generate
   ```

3. パーミッションの確認
   ```bash
   chmod -R 775 storage bootstrap/cache
   ```

4. キャッシュのクリア
   ```bash
   php artisan config:clear
   php artisan cache:clear
   php artisan view:clear
   ```

#### 問題: データベース接続エラー

1. `.env` の DB接続情報を再確認
2. Xserverサーバーパネルで「MySQL設定」を確認
3. アクセス権が付与されているか確認
4. 接続テスト：
   ```bash
   php artisan tinker
   >>> DB::connection()->getPdo();
   ```

#### 問題: 画像が表示されない

1. ストレージリンクの確認
   ```bash
   ls -la ~/library_app/public/storage
   # storage -> ../storage/app/public のシンボリックリンクが存在するか確認
   ```

2. 再作成が必要な場合：
   ```bash
   rm ~/library_app/public/storage
   php artisan storage:link
   ```

3. パーミッション確認
   ```bash
   chmod -R 775 storage/app/public
   ```

4. Intervention Image の確認
   ```bash
   php -m | grep -E 'gd|imagick'
   ```

#### 問題: アップロードサイズ制限

1. Xserverサーバーパネルで「php.ini設定」を確認
2. `.htaccess` で上書き（可能な場合）：

```apache
php_value upload_max_filesize 100M
php_value post_max_size 100M
php_value memory_limit 256M
php_value max_execution_time 300
```

#### 問題: ルートが見つからない（404 Not Found）

1. `.htaccess` が正しく配置されているか確認
   ```bash
   ls -la ~/library_app/public/.htaccess
   ```

2. Apache の mod_rewrite が有効か確認
   
3. キャッシュクリア
   ```bash
   php artisan route:clear
   php artisan config:clear
   ```

---

## 5. メンテナンス

### 5.1 バックアップ（Xserver）

#### データベースバックアップ

```bash
# SSH接続して実行
mysqldump -h mysql123.xserver.jp \
  -u xsrv123_user \
  -p \
  xsrv123_library > ~/backups/db_backup_$(date +%Y%m%d).sql
```

#### ファイルバックアップ

```bash
# 画像とアプリケーション全体のバックアップ
cd ~/
tar -czf backups/library_app_$(date +%Y%m%d).tar.gz \
  --exclude='library_app/vendor' \
  --exclude='library_app/node_modules' \
  --exclude='library_app/storage/logs/*' \
  --exclude='library_app/storage/framework/cache/*' \
  library_app/
```

#### ストレージのみバックアップ

```bash
# アップロード画像のバックアップ
cd ~/library_app/storage/app/public
tar -czf ~/backups/uploads_$(date +%Y%m%d).tar.gz uploads/
```

### 5.2 ログのローテーション

Laravelは自動でログをローテーションしますが、手動でクリアする場合：

```bash
# 古いログを圧縮
cd ~/library_app/storage/logs
gzip -9 laravel-*.log

# または削除
rm laravel-$(date -d '30 days ago' +%Y-%m-%d).log
```

### 5.3 更新手順

```bash
# 1. バックアップ（上記参照）

# 2. メンテナンスモードを有効化
php artisan down

# 3. 新バージョンをアップロード（rsync等）

# 4. 依存関係の更新
composer install --no-dev --optimize-autoloader

# 5. データベースマイグレーション実行
php artisan migrate --force

# 6. キャッシュクリアと再生成
php artisan cache:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 7. メンテナンスモードを解除
php artisan up
```

### 5.4 パフォーマンス最適化

```bash
# Opcacheの有効化確認
php -i | grep opcache

# Laravelの最適化コマンド
php artisan optimize

# データベースのインデックス確認
php artisan tinker
>>> DB::select('SHOW INDEX FROM images');
```

---

## 6. 参考情報

### 6.1 使用技術

- **フレームワーク**: Laravel 10.x
- **言語**: PHP 8.2
- **データベース**: MySQL 8.0
- **Webサーバー**: Apache 2.4
- **画像処理**: Intervention Image（Imagick/GD バックエンド）
- **開発環境**: Docker / Docker Compose
- **パッケージ管理**: Composer

### 6.2 主要なPHP拡張

- `pdo_mysql`: データベース接続
- `gd`: 画像処理（フォールバック）
- `imagick`: 画像処理（優先）
- `zip`: ファイル圧縮
- `mbstring`: マルチバイト文字列処理
- `xml`: XML処理
- `bcmath`: 数値計算

### 6.3 Laravelパッケージ

- `intervention/image`: 画像処理ライブラリ
- その他、必要に応じて追加

### 6.4 参考リンク

- Laravel ドキュメント: https://laravel.com/docs/10.x
- Intervention Image: http://image.intervention.io/
- Xserver マニュアル: https://www.xserver.ne.jp/manual/
- PHP マニュアル: https://www.php.net/manual/ja/
- Docker ドキュメント: https://docs.docker.com/
- Composer: https://getcomposer.org/

### 6.5 Laravel Artisan コマンド一覧

```bash
# キャッシュ関連
php artisan cache:clear          # キャッシュクリア
php artisan config:cache         # 設定キャッシュ生成
php artisan route:cache          # ルートキャッシュ生成
php artisan view:cache           # ビューキャッシュ生成
php artisan optimize             # 全体最適化

# データベース関連
php artisan migrate              # マイグレーション実行
php artisan migrate:rollback     # ロールバック
php artisan migrate:fresh        # 全テーブル削除して再実行
php artisan db:seed              # シーダー実行

# ストレージ関連
php artisan storage:link         # ストレージリンク作成

# メンテナンスモード
php artisan down                 # メンテナンスモード有効
php artisan up                   # メンテナンスモード解除

# その他
php artisan key:generate         # APP_KEY生成
php artisan tinker               # 対話型シェル
php artisan list                 # 全コマンド一覧
```

---

## 付録 A: Docker Composeコマンド一覧

```bash
# 起動
docker-compose up -d

# 停止
docker-compose down

# 再起動
docker-compose restart

# ログ確認
docker-compose logs -f [service_name]

# コンテナ内でコマンド実行
docker-compose exec app bash
docker-compose exec app php artisan migrate
docker-compose exec db mysql -u library_user -p

# ビルドキャッシュクリア
docker-compose build --no-cache

# ボリューム含めて削除
docker-compose down -v
```

## 付録 B: よく使うSSHコマンド

```bash
# Xserverへ接続
ssh xserver_user@your-server.xsrv.jp

# ファイル転送
scp local_file.txt xserver_user@your-server.xsrv.jp:~/

# ディレクトリ同期
rsync -avz local_dir/ xserver_user@your-server.xsrv.jp:~/remote_dir/

# パーミッション一括変更
find storage -type d -exec chmod 775 {} \;
find storage -type f -exec chmod 664 {} \;

# ディスク使用量確認
du -sh ~/library_app/*

# プロセス確認
ps aux | grep php
```

## 付録 C: Git デプロイ（応用）

本番環境でGitを使用したデプロイを行う場合：

```bash
# Xserver上でGitリポジトリをクローン
cd ~/
git clone https://github.com/yourname/library_app.git

# 更新時
cd ~/library_app
git pull origin main
composer install --no-dev --optimize-autoloader
php artisan migrate --force
php artisan optimize
```

**注意**: `.env` ファイルはGitで管理せず、サーバー上で個別に作成してください。
