# SNCライブラリ - グラフィックデザイン：設計書（簡易）

作成日: 2026-02-04

## 1. ディレクトリ設計（案）
Laravel標準のディレクトリ構成を使用：
- `app/` : アプリケーションコード
  - `Http/Controllers/` : コントローラー
  - `Models/` : Eloquentモデル
  - `Services/` : ビジネスロジック（画像処理など）
  - `Http/Middleware/` : ミドルウェア（認証など）
- `resources/` : ビュー、アセット
  - `views/` : Bladeテンプレート
  - `css/` : CSS（Vite）
  - `js/` : JavaScript（Vite）
- `public/` : Webルート
  - `index.php` : エントリーポイント
  - `build/` : Viteビルド出力
- `storage/` : ストレージ
  - `app/public/uploads/` : 画像保存領域（original/display/thumb）
- `database/` : マイグレーション、シーダー
- `routes/` : ルート定義（web.php）
- `config/` : 設定ファイル

## 2. ルーティング（案）
`routes/web.php` に定義（Laravel RESTful規約に準拠）：

### 公開画面
- `GET /` → `HomeController@index` 一覧
- `GET /api/images` → `Api\ImageController@index` 一覧データ（フィルタ反映、JS用）
- `GET /api/images/{id}` → `Api\ImageController@show` 詳細データ

### 管理画面（ミドルウェア: admin.auth）
- `GET /admin/login` → `Admin\AuthController@showLoginForm` ログイン画面
- `POST /admin/login` → `Admin\AuthController@login` ログイン処理
- `POST /admin/logout` → `Admin\AuthController@logout` ログアウト
- `GET /admin` → `Admin\DashboardController@index` ダッシュボード

#### 画像管理（Resource Controller）
- `GET /admin/images` → `Admin\ImageController@index` 一覧
- `GET /admin/images/create` → `Admin\ImageController@create` アップロード画面
- `POST /admin/images` → `Admin\ImageController@store` アップロード処理
- `GET /admin/images/{id}/edit` → `Admin\ImageController@edit` 編集画面
- `PUT /admin/images/{id}` → `Admin\ImageController@update` 更新処理
- `DELETE /admin/images/{id}` → `Admin\ImageController@destroy` 削除処理

#### ジャンル管理（Resource Controller）
- `Resource: /admin/genres` → `Admin\GenreController`

#### タグ管理（Resource Controller）
- `Resource: /admin/tags` → `Admin\TagController`

## 3. DB設計（案）
### 3.1 テーブル
- `genres`
- `tags`
- `images`
- `image_tag`（中間テーブル、Laravel命名規約）

### 3.2 主要カラム案（Laravelマイグレーション）
- `genres`: `id`, `name(unique)`, `created_at`, `updated_at`
- `tags`: `id`, `name(unique)`, `created_at`, `updated_at`
- `images`:
  - `id`
  - `genre_id`（FK）
  - `memo`（TEXT, nullable）
  - `original_path`, `display_path`, `thumb_path`
  - `original_name`, `mime_type`
  - `width`, `height`（unsigned integer）
  - `created_at`, `updated_at`
- `image_tag`: `image_id`, `tag_id`（複合PK、外部キー制約）

### 3.3 Eloquentモデル
- `Genre` → hasManyリレーション（images）
- `Tag` → belongsToManyリレーション（images）
- `Image` → belongsToリレーション（genre）、belongsToManyリレーション（tags）

## 4. 画像処理設計（案）
Intervention Imageライブラリを使用：
- 受け入れたファイルは、Laravelのファイルアップロード機能で一時保存
- Intervention Imageで画像を読み込み、幅高を取得
- `display` 生成:
  - 長辺 > 4096 の場合は縮小（`resize()`メソッド）
  - 長辺 <= 4096 は等倍で保存
- `thumb` 生成:
  - 長辺512px目安（`fit()`または`resize()`メソッド）
- アニメ画像:
  - `original` は原本を `Storage::put()` で保存
  - `display/thumb` は先頭フレームを静止画化して生成
- 保存先: `storage/app/public/uploads/{original,display,thumb}/`
- ファイル名: UUID v4を使用（`Str::uuid()`）

## 5. セキュリティ設計（案）
- 管理操作はカスタムミドルウェア `AdminAuth` で保護
- CSRFトークン: Laravel標準の `@csrf` ディレクティブを使用
- SQL: Eloquent ORMで自動エスケープ
- バリデーション: FormRequestクラスで実装
- 画像ファイル名: `Str::uuid()` でUUID化
- パスワードハッシュ: `Hash::make()` と `Hash::check()` を使用
- セッション管理: Laravel標準のセッション機能

