# SNCライブラリ：設計書（簡易）

作成日: 2026-02-04  
更新日: 2026-02-05（2種類のライブラリ対応）

## 1. ディレクトリ設計（案）
Laravel標準のディレクトリ構成を使用：
- `app/` : アプリケーションコード
  - `Http/Controllers/` : コントローラー
    - `Graphic/` : グラフィックデザイン用コントローラー
    - `Spatial/` : 空間デザイン用コントローラー
    - `Admin/` : 管理画面用コントローラー（共通）
  - `Models/` : Eloquentモデル
  - `Services/` : ビジネスロジック（画像処理など）
  - `Http/Middleware/` : ミドルウェア（認証など）
- `resources/` : ビュー、アセット
  - `views/` : Bladeテンプレート
    - `graphic/` : グラフィックデザイン用ビュー
    - `spatial/` : 空間デザイン用ビュー
    - `admin/` : 管理画面用ビュー
  - `css/` : CSS（Vite）
  - `js/` : JavaScript（Vite）
- `public/` : Webルート
  - `index.php` : エントリーポイント
  - `build/` : Viteビルド出力
- `storage/` : ストレージ
  - `app/public/uploads/graphic/` : グラフィックデザイン画像保存領域
  - `app/public/uploads/spatial/` : 空間デザイン画像保存領域
- `database/` : マイグレーション、シーダー
- `routes/` : ルート定義（web.php）
- `config/` : 設定ファイル

## 2. ルーティング（案）
`routes/web.php` に定義（Laravel RESTful規約に準拠）：

### 公開画面 - グラフィックデザイン
- `GET /graphic` → `Graphic\HomeController@index` 一覧
- `GET /graphic/api/images` → `Graphic\Api\ImageController@index` 一覧データ（JS用）
- `GET /graphic/api/images/{id}` → `Graphic\Api\ImageController@show` 詳細データ

### 公開画面 - 空間デザイン
- `GET /spatial` → `Spatial\HomeController@index` 一覧
- `GET /spatial/api/images` → `Spatial\Api\ImageController@index` 一覧データ（JS用）
- `GET /spatial/api/images/{id}` → `Spatial\Api\ImageController@show` 詳細データ

### 管理画面 - 認証（共通）
- `GET /admin/login` → `Admin\AuthController@showLoginForm` ログイン画面
- `POST /admin/login` → `Admin\AuthController@login` ログイン処理
- `POST /admin/logout` → `Admin\AuthController@logout` ログアウト
- `GET /admin` → `Admin\DashboardController@index` ダッシュボード（両ライブラリの統計表示）

### 管理画面 - グラフィックデザイン（ミドルウェア: admin.auth）
- `Resource: /admin/graphic/genres` → `Admin\Graphic\GenreController`
- `Resource: /admin/graphic/tags` → `Admin\Graphic\TagController`
- `Resource: /admin/graphic/images` → `Admin\Graphic\ImageController`

### 管理画面 - 空間デザイン（ミドルウェア: admin.auth）
- `Resource: /admin/spatial/genres` → `Admin\Spatial\GenreController`
- `Resource: /admin/spatial/tags` → `Admin\Spatial\TagController`
- `Resource: /admin/spatial/images` → `Admin\Spatial\ImageController`

## 3. DB設計（案）
### 3.1 テーブル
- `genres`
- `tags`
- `images`
- `image_tag`（中間テーブル、Laravel命名規約）

### 3.2 主要カラム案（Laravelマイグレーション）
- `genres`: 
  - `id`, `library_type` (enum: 'graphic', 'spatial'), `name`, `created_at`, `updated_at`
  - UNIQUE KEY: (`library_type`, `name`)
  
- `tags`: 
  - `id`, `library_type` (enum: 'graphic', 'spatial'), `name`, `created_at`, `updated_at`
  - UNIQUE KEY: (`library_type`, `name`)
  
- `images`:
  - `id`
  - `library_type` (enum: 'graphic', 'spatial')
  - `genre_id`（FK）
  - `memo`（TEXT, nullable）
  - `original_path`, `display_path`, `thumb_path`
  - `original_name`, `mime_type`
  - `width`, `height`（unsigned integer）
  - `created_at`, `updated_at`
  - INDEX: `library_type`, `genre_id`, `created_at`
  
- `image_tag`: `image_id`, `tag_id`（複合PK、外部キー制約）

### 3.3 Eloquentモデル
- `Genre` → hasManyリレーション（images）、スコープ（byLibraryType）
- `Tag` → belongsToManyリレーション（images）、スコープ（byLibraryType）
- `Image` → belongsToリレーション（genre）、belongsToManyリレーション（tags）、スコープ（byLibraryType）

## 4. 画像処理設計（案）
Intervention Imageライブラリを使用：
- 受け入れたファイルは、Laravelのファイルアップロード機能で一時保存
- Intervention Imageで画像を読み込み、幅高を取得
- `display` 生成:
  - 長辺 > 4096 の場合は縮小（`resize()`メソッド）
  - 長辺 <= 4096 は等倍で保存
- `thumb` 生成:
  - 長辺512px目安（`fit()`または`resize()`メソッド）
- アニメ画像:
  - `original` は原本を `Storage::put()` で保存
  - `display/thumb` は先頭フレームを静止画化して生成
- 保存先: `storage/app/public/uploads/{original,display,thumb}/`
- ファイル名: UUID v4を使用（`Str::uuid()`）

## 5. セキュリティ設計（案）
- 管理操作はカスタムミドルウェア `AdminAuth` で保護
- CSRFトークン: Laravel標準の `@csrf` ディレクティブを使用
- SQL: Eloquent ORMで自動エスケープ
- バリデーション: FormRequestクラスで実装
- 画像ファイル名: `Str::uuid()` でUUID化
- パスワードハッシュ: `Hash::make()` と `Hash::check()` を使用
- セッション管理: Laravel標準のセッション機能

